storage:
  bootType: efi
  disks:
  - partitionTableType: gpt
    maxSize: 5120M
    partitions:
    - id: esp
      type: esp
      start: 1M
      end: 9M

    - id: boot
      start: 9M
      end: 1024M

    - id: root
      label: root
      start: 1024M
      end: 3072M

    - id: verityhash
      label: root-hash
      start: 3072M
      end: 3200M

    - id: var
      start: 3200M

  fileSystems:
  - deviceId: esp
    type: fat32
    mountPoint:
      path: /boot/efi
      options: umask=0077

  - deviceId: boot
    type: ext4
    mountPoint:
      path: /boot

  - deviceId: root
    type: ext4
    mountPoint:
      path: /
      
  - deviceId: verityhash
    type: fat32

  - deviceId: var
    type: ext4
    mountPoint:
      path: /var
      options: defaults,x-initrd.mount

os:
  resetBootLoaderType: hard-reset
  
  additionalFiles:
    files/dracut-overlay.conf: /etc/dracut.conf.d/dracut-overlay.conf

  kernelCommandLine:
    extraCommandLine: systemd.log_level=debug

  packages:
    install:
    - openssh-server
    - veritysetup
    - vim

  services:
    enable:
    - sshd

  users:
  - name: root
    password:
      type: plain-text
      value: hello
      
  - name: chris
    sshPublicKeyPaths:
    - /home/chris/.ssh/id_ed25519.pub

  verity:
    corruptionOption: panic
    dataPartition:
      idType: part-label
      id: root
    hashPartition:
      idType: part-label
      id: root-hash

scripts:
  postCustomization:
  - content: |
      set -eux

      sed -i "s|#LogLevel=info|LogLevel=debug|" /etc/systemd/system.conf
      cat /etc/systemd/system.conf

      #sed -i "s| ro ||" /boot/mariner.cfg
      #cat /boot/mariner.cfg

      OVERLAY_ETC_UPPER=/var/overlays/etc/upper
      OVERLAY_ETC_WORK=/var/overlays/etc/work

      mkdir -p "$OVERLAY_ETC_UPPER"
      mkdir -p "$OVERLAY_ETC_WORK"

      cat << EOF >> /etc/fstab
      overlay /etc overlay auto,x-initrd.mount,x-systemd.requires=/sysroot/var,lowerdir=/sysroot/etc,upperdir=/sysroot$OVERLAY_ETC_UPPER,workdir=/sysroot$OVERLAY_ETC_WORK 0 0
      EOF

      cat /etc/fstab
